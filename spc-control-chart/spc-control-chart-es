{
    "$schema": "https://vega.github.io/schema/vega/v6.json",
    "usermeta": {
        "version": "1.0",
        "developedBy": "José Rafael Escalante",
        "gitHub": "https://github.com/jrescalante",
        "linkedIn": "https://www.linkedin.com/in/jrescalante/",
        "email": "jrescalante@sentidoanalitica.com",
        "visualName": "Gráfico de Control SPC",
        "visualDescription": "Gráfico de control (SPC) con límites ±1σ/±2σ/±3σ, reglas WECO, KPIs adaptativas con o sin USL/LSL, paleta accesible, tooltips y formato numérico hispano.",
        "doc": {
            "etapa_datos": [
                "Locale numérico hispano (coma decimal, punto miles).",
                "Paleta Okabe-Ito accesible: dentro #0072B2, alerta #E69F00 (borde #8c5a00), fuera #D55E00."
            ],
            "etapa_senales_layout": [
                "Señales de tamaño y padding para ubicar tarjetas KPI y grilla WECO.",
                "Derivados de CL/σ (upper1/2, lower1/2, ucl, lcl) usados en guías y franjas."
            ],
            "etapa_transformaciones": [
                "dataset -> joinaggregate: CL=mean(Medicion), sigma=stdevp(Medicion), UCL/LCL=CL±3σ.",
                "Reglas WECO r1–r8 por punto usando ventanas móviles sobre z, signos y tendencias."
            ],
            "etapa_visual": [
                "Fondos zonales: rojo fuera UCL/LCL, ámbar entre ±2σ y ±1σ, azul dentro ±1σ.",
                "Líneas CL, UCL/LCL, ±1σ, ±2σ, etiqueta median; media móvil punteada gris."
            ],
            "etapa_tooltips": [
                "Tooltips: Obs, Medicion, CL, UCL, LCL, Estado, Run7, MediaMovil en formato ,.2f."
            ],
            "etapa_kpi": [
                "Tarjetas superiores: Cpk (ámbar, opcional), viol.CL (rojo suave), σ y CL (neutros), UCL/LCL (neutros); USL/LSL aparecen solo con specs."
            ],
            "etapa_uso_deneb": [
                "Pega el spec en Deneb; luego datos con Observacion/Medicion (y usl/lsl si existen).",
                "Interacción: solo tooltips (sin brush ni cross-filter)."
            ],
            "doc_data": {
                "dataset": "Valida Observacion/Medicion, ordena, calcula CL (media), sigma (stdevp), UCL/LCL y estados/WECO por punto.",
                "ystats": "Agregados min/max de med_val y límites para dominio vertical.",
                "kpi": "KPIs globales: CL, UCL/LCL, sigma, violaciones; Cpk solo si hay USL/LSL.",
                "dataset_out": "Puntos fuera de control (estado 'fuera') para resaltado y tooltip dedicado.",
                "rules_summary": "Resumen WECO: cuenta violaciones r1–r8 sobre el conjunto actual.",
                "rules_grid": "Plantilla fija de 8 reglas WECO para la matriz de KPI visual.",
                "cards": "Tarjetas KPI; USL/LSL y Cpk son opcionales y aparecen solo si hay especificaciones."
            }
        }
    },
    "bounds": "flush",
    "autosize": {
        "resize": true,
        "type": "fit",
        "contains": "padding"
    },
    "width": { "signal": "viewW" },
    "height": { "signal": "viewH" },
    "padding": { "top": 0, "right": 18, "bottom": 0, "left": 0 },
    "background": "white",
    "description": "Control chart (Shewhart) con zonas ±1σ/±2σ/±3σ, reglas WECO; interacción: solo tooltips (sin brush).",
    "data": [
        {
        "name": "dataset",
        "values": [],
        "transform": [
            { "type": "filter", "expr": "isValid(datum.Medicion) && isValid(datum.Observacion)" },
            { "type": "formula", "as": "obs_num", "expr": "toNumber(datum.Observacion)" },
            { "type": "formula", "as": "med_val", "expr": "toNumber(datum.Medicion)" },
            { "type": "filter", "expr": "isValid(datum.obs_num) && isValid(datum.med_val)" },
            { "type": "collect", "sort": { "field": "obs_num", "order": "ascending" } },
            {
            "type": "joinaggregate",
            "fields": ["med_val", "med_val"],
            "ops": ["mean", "stdevp"],
            "as": ["cl", "sigma"]
            },
            { "type": "formula", "as": "ucl", "expr": "datum.cl + 3 * datum.sigma" },
            { "type": "formula", "as": "lcl", "expr": "datum.cl - 3 * datum.sigma" },
            { "type": "formula", "as": "uslVal", "expr": "isValid(datum.usl) ? toNumber(datum.usl) : null" },
            { "type": "formula", "as": "lslVal", "expr": "isValid(datum.lsl) ? toNumber(datum.lsl) : null" },
            { "type": "formula", "as": "isAbove", "expr": "datum.med_val >= datum.cl ? 1 : 0" },
            { "type": "formula", "as": "isBelow", "expr": "datum.med_val < datum.cl ? 1 : 0" },
            { "type": "window", "ops": ["sum", "sum"], "fields": ["isAbove", "isBelow"], "frame": [-6, 0], "as": ["runAbove7", "runBelow7"] },
            {
            "type": "formula",
            "as": "estado",
            "expr": "datum.med_val > datum.ucl || datum.med_val < datum.lcl ? 'fuera' : abs(datum.med_val - datum.cl) >= datum.sigma ? 'alerta' : 'dentro'"
            },
            { "type": "formula", "as": "violCL", "expr": "datum.med_val > datum.ucl || datum.med_val < datum.lcl ? 1 : 0" },
            { "type": "formula", "as": "violUSL", "expr": "isValid(datum.uslVal) && datum.med_val > datum.uslVal ? 1 : 0" },
            { "type": "formula", "as": "violLSL", "expr": "isValid(datum.lslVal) && datum.med_val < datum.lslVal ? 1 : 0" },
            {
            "type": "formula",
            "as": "runFlag",
            "expr": "datum.runAbove7 == 7 || datum.runBelow7 == 7 ? 1 : 0"
            },
            {
            "type": "window",
            "ops": ["mean"],
            "fields": ["med_val"],
            "frame": [-6, 0],
            "as": ["run_mean"]
            }
            ,
            { "type": "formula", "as": "z", "expr": "datum.sigma > 0 ? (datum.med_val - datum.cl) / datum.sigma : 0" },
            { "type": "window", "ops": ["lag"], "fields": ["med_val"], "frame": [-1, -1], "as": ["lag1"] },
            { "type": "formula", "as": "inc", "expr": "isValid(datum.lag1) ? datum.med_val > datum.lag1 : false" },
            { "type": "formula", "as": "dec", "expr": "isValid(datum.lag1) ? datum.med_val < datum.lag1 : false" },
            { "type": "formula", "as": "sign", "expr": "datum.z > 0 ? 1 : datum.z < 0 ? -1 : 0" },
            { "type": "window", "ops": ["lag"], "fields": ["sign"], "frame": [-1, -1], "as": ["lag_sign"] },
            { "type": "formula", "as": "sign_change", "expr": "datum.sign !== 0 && datum.lag_sign !== 0 && datum.sign !== datum.lag_sign" },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum"], "fields": ["z > 2", "z < -2", "z > 1", "z < -1", "sign > 0", "sign < 0", "inc", "dec", "abs(z) < 1", "abs(z) > 1"], "frame": [-7, 0], "as": ["win8_gt2", "win8_lt2", "win8_gt1", "win8_lt1", "win8_pos", "win8_neg", "win8_inc", "win8_dec", "win8_in1", "win8_out1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["z > 2", "z < -2", "z > 1", "z < -1", "abs(z) < 1"], "frame": [-2, 0], "as": ["win3_gt2", "win3_lt2", "win3_gt1", "win3_lt1", "win3_in1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["z > 1", "z < -1", "sign > 0", "sign < 0", "abs(z) < 1"], "frame": [-4, 0], "as": ["win5_gt1", "win5_lt1", "win5_pos", "win5_neg", "win5_in1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum"], "fields": ["sign > 0", "sign < 0", "inc", "dec"], "frame": [-5, 0], "as": ["win6_pos", "win6_neg", "win6_inc", "win6_dec"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["sign > 0", "sign < 0", "sign_change", "abs(z) < 1", "abs(z) > 1"], "frame": [-13, 0], "as": ["win14_pos", "win14_neg", "win14_change", "win14_in1", "win14_out1"] },
            { "type": "window", "ops": ["sum", "sum"], "fields": ["abs(z) < 1", "abs(z) > 1"], "frame": [-14, 0], "as": ["win15_in1", "win15_out1"] },
            { "type": "formula", "as": "r1", "expr": "abs(datum.z) > 3" },
            { "type": "formula", "as": "r2", "expr": "datum.win3_gt2 >= 2 || datum.win3_lt2 >= 2" },
            { "type": "formula", "as": "r3", "expr": "datum.win5_gt1 >= 4 || datum.win5_lt1 >= 4" },
            { "type": "formula", "as": "r4", "expr": "datum.win8_pos == 8 || datum.win8_neg == 8" },
            { "type": "formula", "as": "r5", "expr": "datum.win6_inc == 5 || datum.win6_dec == 5" },
            { "type": "formula", "as": "r6", "expr": "datum.win14_change >= 13" },
            { "type": "formula", "as": "r7", "expr": "datum.win15_in1 == 15" },
            { "type": "formula", "as": "r8", "expr": "datum.win8_out1 == 8" }
        ]
        }
        ,
        {
        "name": "ystats",
        "source": "dataset",
        "transform": [
            {
            "type": "aggregate",
            "fields": ["med_val", "ucl", "lcl", "med_val", "ucl", "lcl"],
            "ops": ["min", "min", "min", "max", "max", "max"],
            "as": ["minMed", "minUCL", "minLCL", "maxMed", "maxUCL", "maxLCL"]
            }
        ]
        }
        ,
        {
        "name": "kpi",
        "source": "dataset",
        "transform": [
            {
            "type": "aggregate",
            "fields": ["cl", "ucl", "lcl", "sigma", "uslVal", "lslVal", "violCL", "violUSL", "violLSL", "med_val"],
            "ops": ["max", "max", "max", "max", "max", "max", "sum", "sum", "sum", "count"],
            "as": ["cl", "ucl", "lcl", "sigma", "usl", "lsl", "violCL", "violUSL", "violLSL", "n"]
            },
            { "type": "formula", "as": "pctCL", "expr": "datum.n > 0 ? datum.violCL / datum.n : 0" },
            { "type": "formula", "as": "pctUSL", "expr": "datum.n > 0 ? datum.violUSL / datum.n : 0" },
            { "type": "formula", "as": "pctLSL", "expr": "datum.n > 0 ? datum.violLSL / datum.n : 0" },
            { "type": "formula", "as": "cpk", "expr": "datum.sigma > 0 && isValid(datum.usl) && isValid(datum.lsl) ? min((datum.usl - datum.cl) / (3 * datum.sigma), (datum.cl - datum.lsl) / (3 * datum.sigma)) : null" }
        ]
        }
        ,
        {
        "name": "dataset_out",
        "source": "dataset",
        "transform": [ { "type": "filter", "expr": "datum.estado === 'fuera'" } ]
        }
        ,
        {
        "name": "rules_summary",
        "source": "dataset",
        "transform": [
            { "type": "aggregate", "fields": ["r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8"], "ops": ["sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum"], "as": ["r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8"] }
        ]
        }
        ,
        {
        "name": "rules_grid",
        "values": [
            { "idx": 0, "rule": "Regla 1", "desc": "1 > 3σ", "field": "r1" },
            { "idx": 1, "rule": "Regla 2", "desc": "2 de 3 > 2σ", "field": "r2" },
            { "idx": 2, "rule": "Regla 3", "desc": "4 de 5 > 1σ", "field": "r3" },
            { "idx": 3, "rule": "Regla 4", "desc": "8 mismo lado", "field": "r4" },
            { "idx": 4, "rule": "Regla 5", "desc": "6 en tendencia", "field": "r5" },
            { "idx": 5, "rule": "Regla 6", "desc": "14 alternando", "field": "r6" },
            { "idx": 6, "rule": "Regla 7", "desc": "15 dentro 1σ", "field": "r7" },
            { "idx": 7, "rule": "Regla 8", "desc": "8 fuera 1σ", "field": "r8" }
        ],
        "transform": [
            { "type": "formula", "as": "count", "expr": "data('rules_summary').length ? data('rules_summary')[0][datum.field] : 0" }
        ]
        },
        {
        "name": "cards",
        "values": [
            { "idx": 0, "label": "Cpk", "field": "cpk", "fmt": ".3f", "bg": "#fff4ce", "optional": true },
            { "idx": 1, "label": "viol. CL", "field": "pctCL", "fmt": ".1%", "bg": "#fdecea" },
            { "idx": 2, "label": "σ", "field": "sigma", "fmt": ".3f", "bg": "#eef5ff" },
            { "idx": 3, "label": "CL", "field": "cl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 4, "label": "UCL", "field": "ucl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 5, "label": "LCL", "field": "lcl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 6, "label": "USL", "field": "usl", "fmt": ".3f", "bg": "#f5f5f5", "optional": true },
            { "idx": 7, "label": "LSL", "field": "lsl", "fmt": ".3f", "bg": "#f5f5f5", "optional": true }
        ],
        "transform": [
            { "type": "filter", "expr": "showSpecs || datum.optional != true" },
            { "type": "window", "ops": ["row_number"], "as": ["idxDyn"] }
        ]
        }
    ],
    "signals": [
        { "name": "container", "update": "containerSize()" },
        { "name": "viewW", "update": "container[0]" },
        { "name": "viewH", "update": "container[1]" },
        {
        "name": "hover",
        "value": null,
        "on": [
            { "events": "symbol:mouseover", "update": "datum" },
            { "events": "symbol:mouseout", "update": "null" }
        ]
        },
        { "name": "mousex", "value": 0, "on": [ { "events": "mousemove", "update": "x()" } ] },
        { "name": "mousey", "value": 0, "on": [ { "events": "mousemove", "update": "y()" } ] },
        { "name": "crossX", "update": "clamp(mousex, 0, width)" },
        { "name": "hasUSL", "update": "data('kpi').length ? isValid(data('kpi')[0].usl) && data('kpi')[0].usl != null : false" },
        { "name": "hasLSL", "update": "data('kpi').length ? isValid(data('kpi')[0].lsl) && data('kpi')[0].lsl != null : false" },
        { "name": "showSpecs", "update": "hasUSL && hasLSL" },
        { "name": "crossY", "update": "clamp(mousey, 0, height)" }
        ,
        {
            "name": "hostSel",
            "value": null,
            "on": [
            {
                "events": "symbol:click",
                "update": "datum && datum['__selectionId__']",
                "push": "outer"
            }
            ]
        }
            ,
            { "name": "ymin", "update": "data('ystats').length ? min([data('ystats')[0].minMed, data('ystats')[0].minUCL, data('ystats')[0].minLCL]) : 0" },
            { "name": "ymax", "update": "data('ystats').length ? max([data('ystats')[0].maxMed, data('ystats')[0].maxUCL, data('ystats')[0].maxLCL]) : 1" },
            { "name": "uclSig", "update": "data('ystats').length ? data('ystats')[0].maxUCL : 0" },
            { "name": "lclSig", "update": "data('ystats').length ? data('ystats')[0].minLCL : 0" },
            { "name": "specUSL", "update": "data('dataset').length ? data('dataset')[0].ucl : null" },
            { "name": "specLSL", "update": "data('dataset').length ? data('dataset')[0].lcl : null" },
            { "name": "clSig", "update": "data('dataset').length ? data('dataset')[0].cl : 0" },
            { "name": "sigSig", "update": "data('dataset').length ? data('dataset')[0].sigma : 0" },
            { "name": "upper1", "update": "clSig + sigSig" },
            { "name": "lower1", "update": "clSig - sigSig" },
            { "name": "upper2", "update": "clSig + 2*sigSig" },
            { "name": "lower2", "update": "clSig - 2*sigSig" },
            { "name": "yPad", "update": "(ymax - ymin) * 0.1" },
            { "name": "yMinDom", "update": "ymin - yPad" },
            { "name": "yMaxDom", "update": "ymax + yPad" }
        ,
        {
            "name": "yDomain",
            "update": "null"
        },
        { "name": "cardH", "update": "32" },
        { "name": "cardY", "update": "-cardH - 4" },
        { "name": "gridCell", "update": "18" },
        { "name": "gridCols", "update": "4" },
        { "name": "gridRows", "update": "2" },
        { "name": "gridPad", "update": "4" },
        { "name": "gridWidth", "update": "gridCols * gridCell + gridPad" },
        { "name": "cardsAvailable", "update": "max(140, width - gridWidth - 8)" },
        { "name": "cardW", "update": "cardsAvailable / max(1, data('cards').length)" },
        { "name": "gridX", "update": "width - gridWidth" },
        { "name": "gridY", "update": "cardY" },
        { "name": "xCount", "update": "data('dataset').length" },
        { "name": "xTarget", "update": "max(2, ceil(width / 40))" },
        { "name": "xLabelStep", "update": "xCount && xTarget ? ceil(xCount / xTarget) : 1" }
    ],
    "scales": [
        {
        "name": "x",
        "type": "band",
        "range": "width",
        "padding": 0.15,
        "domain": { "data": "dataset", "field": "obs_num" }
        },
        {
        "name": "y",
        "type": "linear",
        "range": "height",
        "nice": true,
        "zero": false,
        "domain": {
            "fields": [
                { "data": "dataset", "field": "med_val" },
                { "data": "dataset", "field": "ucl" },
                { "data": "dataset", "field": "lcl" }
            ]
        }
        },
        {
        "name": "color",
        "type": "ordinal",
        "domain": ["fuera", "alerta", "dentro"],
        "range": ["#D55E00", "#E69F00", "#0072B2"]
            }
    ],
    "axes": [
        { "orient": "bottom", "scale": "x", "title": "Observación", "labelAngle": 0, "labelAlign": "center", "labelBaseline": "middle", "labelPadding": 9, "labelFont": "Segoe UI", "labelFontStyle": "normal", "labelOverlap": "greedy", "titleFont": "Bahnschrift SemiBold", "titleFontSize": 12, "titleColor": "#6f6f6f", "tickCount": { "signal": "ceil(width / 28)" } },
        { "orient": "left", "scale": "y", "title": "Medición", "labelFont": "Bahnschrift", "labelFontStyle": "normal", "titleFont": "Bahnschrift SemiBold", "titleFontSize": 12, "titleColor": "#6f6f6f" }
    ],
    "legends": [],
    "marks": [
        {
        "type": "rect",
        "description": "Fondo zona fuera de control por encima de UCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "value": 0 },
            "y2": { "scale": "y", "signal": "uclSig" },
            "fill": { "value": "#f8d4cf" },
            "opacity": { "value": 0.45 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Fondo zona alerta entre UCL y +1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "uclSig" },
            "y2": { "scale": "y", "signal": "upper1" },
            "fill": { "value": "#fde6bc" },
            "opacity": { "value": 0.42 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Fondo zona control dentro de ±1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper1" },
            "y2": { "scale": "y", "signal": "lower1" },
            "fill": { "value": "#dceaf7" },
            "opacity": { "value": 0.5 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Fondo zona alerta entre -1σ y LCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower1" },
            "y2": { "scale": "y", "signal": "lclSig" },
            "fill": { "value": "#fde6bc" },
            "opacity": { "value": 0.42 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Fondo zona fuera de control por debajo de LCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lclSig" },
            "y2": { "signal": "height" },
            "fill": { "value": "#f8d4cf" },
            "opacity": { "value": 0.45 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Guía vertical de referencia (crosshair X)",
        "encode": {
            "update": {
            "x": { "signal": "crossX" },
            "x2": { "signal": "crossX" },
            "y": { "value": 0 },
            "y2": { "signal": "height" },
            "stroke": { "value": "#555" },
            "strokeWidth": { "value": 1 },
            "opacity": { "value": 0.25 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Guía horizontal de referencia (crosshair Y)",
        "encode": {
            "update": {
            "y": { "signal": "crossY" },
            "y2": { "signal": "crossY" },
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "stroke": { "value": "#555" },
            "strokeWidth": { "value": 1 },
            "opacity": { "value": 0.25 }
            }
        }
        },
        {
        "type": "line",
        "description": "Media móvil (ventana 7) para tendencia",
        "from": { "data": "dataset" },
        "encode": {
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "run_mean" },
            "stroke": { "value": "#9c9c9c" },
            "strokeWidth": { "value": 1.2 },
            "strokeDash": { "value": [6, 4] },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "line",
        "description": "Serie principal de mediciones",
        "from": { "data": "dataset" },
        "encode": {
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "stroke": { "value": "#4e79a7" },
            "strokeWidth": { "value": 1.8 }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Puntos con estado (dentro/alerta/fuera) y tooltip detallado",
        "from": { "data": "dataset" },
        "encode": {
            "enter": { "size": { "value": 60 }, "strokeWidth": { "value": 1 }, "shape": { "value": "circle" } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "shape": { "signal": "datum.estado === 'alerta' || datum.estado === 'fuera' ? 'diamond' : 'circle'" },
            "fill": { "signal": "datum.estado === 'alerta' ? '#E69F00' : datum.estado === 'fuera' ? '#D55E00' : '#0072B2'" },
            "stroke": { "signal": "datum.estado === 'alerta' ? '#8c5a00' : '#ffffff'" },
            "strokeWidth": { "signal": "datum.estado === 'alerta' ? 2.4 : 1" },
            "opacity": { "value": 0.92 },
            "tooltip": {
                "signal": "{Observacion: datum.obs_num, Medicion: format(datum.med_val, ',.2f'), CL: format(datum.cl, ',.2f'), UCL: format(datum.ucl, ',.2f'), LCL: format(datum.lcl, ',.2f'), Estado: datum.estado, Run7: datum.runFlag ? 'si' : 'no', MediaMovil: format(datum.run_mean, ',.2f')}"
            }
            },
            "hover": {
            "size": { "value": 110 },
            "stroke": { "value": "#000" }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Outliers (fuera de control) resaltados con halo",
        "from": { "data": "dataset_out" },
        "encode": {
            "enter": { "shape": { "value": "diamond" } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "size": { "value": 260 },
            "fill": { "value": "#ffffff" },
            "fillOpacity": { "value": 0.65 },
            "stroke": { "value": "#D55E00" },
            "strokeWidth": { "value": 1.7 },
            "opacity": { "value": 1 },
            "tooltip": {
                "signal": "{Observacion: datum.obs_num, Medicion: format(datum.med_val, ',.2f'), CL: format(datum.cl, ',.2f'), UCL: format(datum.ucl, ',.2f'), LCL: format(datum.lcl, ',.2f'), Estado: datum.estado}"
            }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Halo/énfasis en runFlag o hover",
        "from": { "data": "dataset" },
        "encode": {
            "enter": { "size": { "value": 0 } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "shape": { "signal": "datum.estado === 'alerta' || datum.estado === 'fuera' ? 'diamond' : 'circle'" },
            "fill": { "signal": "datum.estado === 'fuera' ? '#e63e44' : '#2c7bb6'" },
            "stroke": { "signal": "datum.estado === 'alerta' ? '#f7b500' : datum.estado === 'fuera' ? '#e63e44' : '#2c7bb6'" },
            "strokeWidth": { "signal": "datum.estado === 'alerta' || datum.estado === 'fuera' ? 3 : 2" },
            "size": { "signal": "(hover && hover.obs_num === datum.obs_num) || datum.runFlag ? 200 : 0" },
            "opacity": { "signal": "datum.runFlag ? 1 : 0.9" }
            }
        }
        },
        {
        "type": "rule",
        "description": "Línea CL (central) punteada",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0" },
            "stroke": { "value": "#f28e2c" },
            "strokeDash": { "value": [6, 3] },
            "strokeWidth": { "value": 2 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Límite superior de control UCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].ucl : 0" },
            "stroke": { "value": "#e15759" },
            "strokeDash": { "value": [3, 3] },
            "strokeWidth": { "value": 1.6 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "+1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper1" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.7 }
            }
        }
        },
        {
        "type": "rule",
        "description": "+2σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper2" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.55 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Límite inferior de control LCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].lcl : 0" },
            "stroke": { "value": "#e15759" },
            "strokeDash": { "value": [3, 3] },
            "strokeWidth": { "value": 1.6 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "-1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower1" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.7 }
            }
        }
        },
        {
        "type": "rule",
        "description": "-2σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower2" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.55 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].ucl : 0", "offset": -6 },
            "text": { "value": "UCL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "upper1" },
            "text": { "value": "+1σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "upper2" },
            "text": { "value": "+2σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0", "offset": -6 },
            "text": { "value": "CL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0", "offset": 10 },
            "text": { "value": "median" },
            "align": { "value": "left" },
            "baseline": { "value": "top" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "fontStyle": { "value": "italic" },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].lcl : 0", "offset": -6 },
            "text": { "value": "LCL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        }
        ,
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "lower1" },
            "text": { "value": "-1σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        }
        ,
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "lower2" },
            "text": { "value": "-2σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        }
        ,
        {
        "type": "rule",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
                "y": { "value": 0 },
                "stroke": { "value": "#7e3f98" },
                "strokeDash": { "value": [4, 3] },
                "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "rule",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
                "y": { "value": 0 },
                "stroke": { "value": "#7e3f98" },
                "strokeDash": { "value": [4, 3] },
                "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
                "x": { "value": 0 },
                "y": { "value": 0 },
                "text": { "value": "" },
                "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
                "x": { "value": 0 },
                "y": { "value": 0 },
                "text": { "value": "" },
                "opacity": { "value": 0 }
            }
        }
        }
        
        ,
        {
        "type": "rect",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx) ) * cardW + 6" },
            "y": { "signal": "cardY" },
            "width": { "signal": "cardW - 8" },
            "height": { "signal": "cardH" },
            "fill": { "field": "bg" },
            "stroke": { "value": "#d7d7d7" },
            "cornerRadius": { "value": 4 },
            "opacity": { "signal": "data('kpi').length ? 0.92 : 0" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx)) * cardW + 12" },
            "y": { "signal": "cardY + 12" },
            "text": { "field": "label" },
            "fontWeight": { "value": "bold" },
            "fontSize": { "value": 11 },
            "fill": { "value": "#2d3436" },
            "opacity": { "signal": "data('kpi').length ? 1 : 0" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx)) * cardW + 12" },
            "y": { "signal": "cardY + 26" },
            "text": { "signal": "data('kpi').length ? format(data('kpi')[0][datum.field], datum.fmt) : ''" },
            "fontSize": { "value": 11 },
            "fill": { "value": "#37474f" }
            }
        }
        }
        ,
        {
        "type": "rect",
        "from": { "data": "rules_grid" },
        "encode": {
            "update": {
            "x": { "signal": "gridX + (datum.idx % gridCols) * gridCell" },
            "y": { "signal": "gridY + floor(datum.idx / gridCols) * gridCell" },
            "width": { "signal": "gridCell - 2" },
            "height": { "signal": "gridCell - 2" },
            "fill": { "signal": "datum.count > 0 ? '#e57373' : '#e0e6f5'" },
            "stroke": { "value": "#aeb7d3" },
            "cornerRadius": { "value": 2 },
            "tooltip": { "signal": "{regla: datum.rule, detalle: datum.desc, violaciones: datum.count}" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "rules_grid" },
        "encode": {
            "update": {
            "x": { "signal": "gridX + (datum.idx % gridCols) * gridCell + (gridCell - 2) / 2" },
            "y": { "signal": "gridY + floor(datum.idx / gridCols) * gridCell + (gridCell - 2) / 2 + 4" },
            "text": { "signal": "datum.count > 0 ? datum.count : ''" },
            "fontSize": { "value": 9 },
            "fontWeight": { "value": "bold" },
            "align": { "value": "center" },
            "fill": { "value": "#2f2f2f" }
            }
        }
        }
    ],
    "config": {
        "axis": { "grid": true, "labelFontSize": 11, "titleFontSize": 12 },
        "legend": { "labelFontSize": 11, "titleFontSize": 12 }
    }
    }
