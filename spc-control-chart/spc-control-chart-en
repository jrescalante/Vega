{
    "$schema": "https://vega.github.io/schema/vega/v6.json",
    "usermeta": {
        "version": "1.0",
        "developedBy": "José Rafael Escalante",
        "gitHub": "https://github.com/jrescalante",
        "linkedIn": "https://www.linkedin.com/in/jrescalante/",
        "email": "jrescalante@sentidoanalitica.com",
        "visualName": "SPC Control Chart",
        "visualDescription": "SPC control chart with ±1σ/±2σ/±3σ limits, WECO rules, adaptive KPIs with or without USL/LSL (Cpk only if specs exist), accessible palette, tooltips, and US-style numeric formatting.",
        "doc": {
            "data_stage": [
                "US numeric locale (dot for decimal, comma for thousands).",
                "Accessible Okabe-Ito palette: in-control #0072B2, alert #E69F00 (border #8c5a00), out-of-control #D55E00."
            ],
            "layout_signals": [
                "Signals for sizing/padding to place KPI cards and WECO grid.",
                "CL/σ derivatives (upper1/2, lower1/2, ucl, lcl) used in guides and bands."
            ],
            "transform_stage": [
                "dataset -> joinaggregate: CL = mean(Measurement), sigma = stdevp(Measurement), UCL/LCL = CL ± 3σ.",
                "WECO rules r1–r8 per point using moving windows over z, signs, and trends."
            ],
            "visual_stage": [
                "Zonal backgrounds: red beyond UCL/LCL, tan between ±2σ and ±1σ, blue within ±1σ.",
                "Lines for CL, UCL/LCL, ±1σ, ±2σ, median label; gray dashed moving average."
            ],
            "tooltip_stage": [
                "Tooltips: Observation, Measurement, CL, UCL, LCL, State, Run7, MovingAvg formatted ,.2f."
            ],
            "kpi_stage": [
                "Cards: optional Cpk (only if USL/LSL exist), CL violations, σ, CL, UCL/LCL, optional USL/LSL."
            ],
            "deneb_usage": [
                "Paste the spec in Deneb; provide data with Observation/Measurement (and usl/lsl if available).",
                "Interaction: tooltips only (no brush or cross-selection)."
            ],
            "doc_data": {
                "dataset": "Validates Observation/Measurement, sorts, computes CL (mean), sigma (stdevp), UCL/LCL, state, and WECO flags.",
                "ystats": "Aggregates min/max of med_val and limits for y-domain.",
                "kpi": "Global KPIs: CL, UCL/LCL, sigma, violations; Cpk only if USL/LSL exist.",
                "dataset_out": "Points out of control (state 'out') for highlight and dedicated tooltip.",
                "rules_summary": "WECO summary: counts violations r1–r8 over current set.",
                "rules_grid": "Fixed 8-rule template for the KPI matrix.",
                "cards": "KPI cards; USL/LSL and Cpk are optional and appear only if specs exist."
            }
        }
    },
    "bounds": "flush",
    "autosize": {
        "resize": true,
        "type": "fit",
        "contains": "padding"
    },
    "width": { "signal": "viewW" },
    "height": { "signal": "viewH" },
    "padding": { "top": 0, "right": 18, "bottom": 0, "left": 0 },
    "background": "white",
    "description": "SPC control chart (Shewhart) with ±1σ/±2σ/±3σ zones, WECO rules; interaction: tooltips only (no brush).",
    "data": [
        {
        "name": "dataset",
        "values": [],
        "transform": [
            { "type": "filter", "expr": "isValid(datum.Measurement) && isValid(datum.Observation)" },
            { "type": "formula", "as": "obs_num", "expr": "toNumber(datum.Observation)" },
            { "type": "formula", "as": "med_val", "expr": "toNumber(datum.Measurement)" },
            { "type": "filter", "expr": "isValid(datum.obs_num) && isValid(datum.med_val)" },
            { "type": "collect", "sort": { "field": "obs_num", "order": "ascending" } },
            { "type": "joinaggregate", "fields": ["med_val", "med_val"], "ops": ["mean", "stdevp"], "as": ["cl", "sigma"] },
            { "type": "formula", "as": "ucl", "expr": "datum.cl + 3 * datum.sigma" },
            { "type": "formula", "as": "lcl", "expr": "datum.cl - 3 * datum.sigma" },
            { "type": "formula", "as": "uslVal", "expr": "isValid(datum.usl) ? toNumber(datum.usl) : null" },
            { "type": "formula", "as": "lslVal", "expr": "isValid(datum.lsl) ? toNumber(datum.lsl) : null" },
            { "type": "formula", "as": "z", "expr": "datum.sigma > 0 ? (datum.med_val - datum.cl) / datum.sigma : 0" },
            { "type": "formula", "as": "isAbove", "expr": "datum.med_val >= datum.cl ? 1 : 0" },
            { "type": "formula", "as": "isBelow", "expr": "datum.med_val < datum.cl ? 1 : 0" },
            { "type": "window", "ops": ["sum", "sum"], "fields": ["isAbove", "isBelow"], "frame": [-6, 0], "as": ["runAbove7", "runBelow7"] },
            { "type": "formula", "as": "state", "expr": "datum.med_val > datum.ucl || datum.med_val < datum.lcl ? 'out' : abs(datum.med_val - datum.cl) >= datum.sigma ? 'alert' : 'in'" },
            { "type": "formula", "as": "violCL", "expr": "datum.state === 'out' ? 1 : 0" },
            { "type": "formula", "as": "violUSL", "expr": "isValid(datum.uslVal) && datum.med_val > datum.uslVal ? 1 : 0" },
            { "type": "formula", "as": "violLSL", "expr": "isValid(datum.lslVal) && datum.med_val < datum.lslVal ? 1 : 0" },
            { "type": "formula", "as": "runFlag", "expr": "datum.runAbove7 == 7 || datum.runBelow7 == 7 ? 1 : 0" },
            { "type": "window", "ops": ["mean"], "fields": ["med_val"], "frame": [-6, 0], "as": ["run_mean"] },
            { "type": "window", "ops": ["lag"], "fields": ["med_val"], "frame": [-1, -1], "as": ["lag1"] },
            { "type": "formula", "as": "inc", "expr": "isValid(datum.lag1) ? datum.med_val > datum.lag1 : false" },
            { "type": "formula", "as": "dec", "expr": "isValid(datum.lag1) ? datum.med_val < datum.lag1 : false" },
            { "type": "formula", "as": "sign", "expr": "datum.z > 0 ? 1 : datum.z < 0 ? -1 : 0" },
            { "type": "window", "ops": ["lag"], "fields": ["sign"], "frame": [-1, -1], "as": ["lag_sign"] },
            { "type": "formula", "as": "sign_change", "expr": "datum.sign !== 0 && datum.lag_sign !== 0 && datum.sign !== datum.lag_sign" },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum"], "fields": ["z > 2", "z < -2", "z > 1", "z < -1", "sign > 0", "sign < 0", "inc", "dec", "abs(z) < 1", "abs(z) > 1"], "frame": [-7, 0], "as": ["win8_gt2", "win8_lt2", "win8_gt1", "win8_lt1", "win8_pos", "win8_neg", "win8_inc", "win8_dec", "win8_in1", "win8_out1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["z > 2", "z < -2", "z > 1", "z < -1", "abs(z) < 1"], "frame": [-2, 0], "as": ["win3_gt2", "win3_lt2", "win3_gt1", "win3_lt1", "win3_in1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["z > 1", "z < -1", "sign > 0", "sign < 0", "abs(z) < 1"], "frame": [-4, 0], "as": ["win5_gt1", "win5_lt1", "win5_pos", "win5_neg", "win5_in1"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum"], "fields": ["sign > 0", "sign < 0", "inc", "dec"], "frame": [-5, 0], "as": ["win6_pos", "win6_neg", "win6_inc", "win6_dec"] },
            { "type": "window", "ops": ["sum", "sum", "sum", "sum", "sum"], "fields": ["sign > 0", "sign < 0", "sign_change", "abs(z) < 1", "abs(z) > 1"], "frame": [-13, 0], "as": ["win14_pos", "win14_neg", "win14_change", "win14_in1", "win14_out1"] },
            { "type": "window", "ops": ["sum", "sum"], "fields": ["abs(z) < 1", "abs(z) > 1"], "frame": [-14, 0], "as": ["win15_in1", "win15_out1"] },
            { "type": "formula", "as": "r1", "expr": "abs(datum.z) > 3" },
            { "type": "formula", "as": "r2", "expr": "datum.win3_gt2 >= 2 || datum.win3_lt2 >= 2" },
            { "type": "formula", "as": "r3", "expr": "datum.win5_gt1 >= 4 || datum.win5_lt1 >= 4" },
            { "type": "formula", "as": "r4", "expr": "datum.win8_pos == 8 || datum.win8_neg == 8" },
            { "type": "formula", "as": "r5", "expr": "datum.win6_inc == 5 || datum.win6_dec == 5" },
            { "type": "formula", "as": "r6", "expr": "datum.win14_change >= 13" },
            { "type": "formula", "as": "r7", "expr": "datum.win15_in1 == 15" },
            { "type": "formula", "as": "r8", "expr": "datum.win8_out1 == 8" }
        ]
        },
        {
        "name": "ystats",
        "source": "dataset",
        "transform": [
            {
            "type": "aggregate",
            "fields": ["med_val", "ucl", "lcl", "med_val", "ucl", "lcl"],
            "ops": ["min", "min", "min", "max", "max", "max"],
            "as": ["minMed", "minUCL", "minLCL", "maxMed", "maxUCL", "maxLCL"]
            }
        ]
        },
        {
        "name": "kpi",
        "source": "dataset",
        "transform": [
            {
            "type": "aggregate",
            "fields": ["cl", "ucl", "lcl", "sigma", "uslVal", "lslVal", "violCL", "violUSL", "violLSL", "med_val"],
            "ops": ["max", "max", "max", "max", "max", "max", "sum", "sum", "sum", "count"],
            "as": ["cl", "ucl", "lcl", "sigma", "usl", "lsl", "violCL", "violUSL", "violLSL", "n"]
            },
            { "type": "formula", "as": "pctCL", "expr": "datum.n > 0 ? datum.violCL / datum.n : 0" },
            { "type": "formula", "as": "pctUSL", "expr": "datum.n > 0 ? datum.violUSL / datum.n : 0" },
            { "type": "formula", "as": "pctLSL", "expr": "datum.n > 0 ? datum.violLSL / datum.n : 0" },
            { "type": "formula", "as": "cpk", "expr": "datum.sigma > 0 && isValid(datum.usl) && isValid(datum.lsl) ? min((datum.usl - datum.cl) / (3 * datum.sigma), (datum.cl - datum.lsl) / (3 * datum.sigma)) : null" }
        ]
        },
        {
        "name": "dataset_out",
        "source": "dataset",
        "transform": [ { "type": "filter", "expr": "datum.state === 'out'" } ]
        },
        {
        "name": "rules_summary",
        "source": "dataset",
        "transform": [
            { "type": "aggregate", "fields": ["r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8"], "ops": ["sum", "sum", "sum", "sum", "sum", "sum", "sum", "sum"], "as": ["r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8"] }
        ]
        },
        {
        "name": "rules_grid",
        "values": [
            { "idx": 0, "rule": "Rule 1", "desc": "1 > 3σ", "field": "r1" },
            { "idx": 1, "rule": "Rule 2", "desc": "2 of 3 > 2σ", "field": "r2" },
            { "idx": 2, "rule": "Rule 3", "desc": "4 of 5 > 1σ", "field": "r3" },
            { "idx": 3, "rule": "Rule 4", "desc": "8 same side", "field": "r4" },
            { "idx": 4, "rule": "Rule 5", "desc": "6 in trend", "field": "r5" },
            { "idx": 5, "rule": "Rule 6", "desc": "14 alternating", "field": "r6" },
            { "idx": 6, "rule": "Rule 7", "desc": "15 within 1σ", "field": "r7" },
            { "idx": 7, "rule": "Rule 8", "desc": "8 outside 1σ", "field": "r8" }
        ],
        "transform": [
            { "type": "formula", "as": "count", "expr": "data('rules_summary').length ? data('rules_summary')[0][datum.field] : 0" }
        ]
        },
        {
        "name": "cards",
        "values": [
            { "idx": 0, "label": "Cpk", "field": "cpk", "fmt": ".3f", "bg": "#fff4ce", "optional": true },
            { "idx": 1, "label": "CL viol.", "field": "pctCL", "fmt": ".1%", "bg": "#fdecea" },
            { "idx": 2, "label": "σ", "field": "sigma", "fmt": ".3f", "bg": "#eef5ff" },
            { "idx": 3, "label": "CL", "field": "cl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 4, "label": "UCL", "field": "ucl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 5, "label": "LCL", "field": "lcl", "fmt": ".3f", "bg": "#f5f5f5" },
            { "idx": 6, "label": "USL", "field": "usl", "fmt": ".3f", "bg": "#f5f5f5", "optional": true },
            { "idx": 7, "label": "LSL", "field": "lsl", "fmt": ".3f", "bg": "#f5f5f5", "optional": true }
        ],
        "transform": [
            { "type": "filter", "expr": "showSpecs || datum.optional != true" },
            { "type": "window", "ops": ["row_number"], "as": ["idxDyn"] }
        ]
        }
    ],
    "signals": [
        { "name": "container", "update": "containerSize()" },
        { "name": "viewW", "update": "container[0]" },
        { "name": "viewH", "update": "container[1]" },
        {
        "name": "hover",
        "value": null,
        "on": [
            { "events": "symbol:mouseover", "update": "datum" },
            { "events": "symbol:mouseout", "update": "null" }
        ]
        },
        { "name": "mousex", "value": 0, "on": [ { "events": "mousemove", "update": "x()" } ] },
        { "name": "mousey", "value": 0, "on": [ { "events": "mousemove", "update": "y()" } ] },
        { "name": "crossX", "update": "clamp(mousex, 0, width)" },
        { "name": "hasUSL", "update": "data('kpi').length ? isValid(data('kpi')[0].usl) && data('kpi')[0].usl != null : false" },
        { "name": "hasLSL", "update": "data('kpi').length ? isValid(data('kpi')[0].lsl) && data('kpi')[0].lsl != null : false" },
        { "name": "showSpecs", "update": "hasUSL && hasLSL" },
        { "name": "crossY", "update": "clamp(mousey, 0, height)" },
        {
            "name": "hostSel",
            "value": null,
            "on": [
            {
                "events": "symbol:click",
                "update": "datum && datum['__selectionId__']",
                "push": "outer"
            }
            ]
        },
        { "name": "ymin", "update": "data('ystats').length ? min([data('ystats')[0].minMed, data('ystats')[0].minUCL, data('ystats')[0].minLCL]) : 0" },
        { "name": "ymax", "update": "data('ystats').length ? max([data('ystats')[0].maxMed, data('ystats')[0].maxUCL, data('ystats')[0].maxLCL]) : 1" },
        { "name": "uclSig", "update": "data('ystats').length ? data('ystats')[0].maxUCL : 0" },
        { "name": "lclSig", "update": "data('ystats').length ? data('ystats')[0].minLCL : 0" },
        { "name": "specUSL", "update": "data('dataset').length ? data('dataset')[0].ucl : null" },
        { "name": "specLSL", "update": "data('dataset').length ? data('dataset')[0].lcl : null" },
        { "name": "clSig", "update": "data('dataset').length ? data('dataset')[0].cl : 0" },
        { "name": "sigSig", "update": "data('dataset').length ? data('dataset')[0].sigma : 0" },
        { "name": "upper1", "update": "clSig + sigSig" },
        { "name": "lower1", "update": "clSig - sigSig" },
        { "name": "upper2", "update": "clSig + 2*sigSig" },
        { "name": "lower2", "update": "clSig - 2*sigSig" },
        { "name": "yPad", "update": "(ymax - ymin) * 0.1" },
        { "name": "yMinDom", "update": "ymin - yPad" },
        { "name": "yMaxDom", "update": "ymax + yPad" },
        { "name": "yDomain", "update": "null" },
        { "name": "cardH", "update": "32" },
        { "name": "cardY", "update": "-cardH - 4" },
        { "name": "gridCell", "update": "18" },
        { "name": "gridCols", "update": "4" },
        { "name": "gridRows", "update": "2" },
        { "name": "gridPad", "update": "4" },
        { "name": "gridWidth", "update": "gridCols * gridCell + gridPad" },
        { "name": "cardsAvailable", "update": "max(140, width - gridWidth - 8)" },
        { "name": "cardW", "update": "cardsAvailable / max(1, data('cards').length)" },
        { "name": "gridX", "update": "width - gridWidth" },
        { "name": "gridY", "update": "cardY" },
        { "name": "xCount", "update": "data('dataset').length" },
        { "name": "xTarget", "update": "max(2, ceil(width / 40))" },
        { "name": "xLabelStep", "update": "xCount && xTarget ? ceil(xCount / xTarget) : 1" }
    ],
    "scales": [
        {
        "name": "x",
        "type": "band",
        "range": "width",
        "padding": 0.15,
        "domain": { "data": "dataset", "field": "obs_num" }
        },
        {
        "name": "y",
        "type": "linear",
        "range": "height",
        "nice": true,
        "zero": false,
        "domain": {
            "fields": [
                { "data": "dataset", "field": "med_val" },
                { "data": "dataset", "field": "ucl" },
                { "data": "dataset", "field": "lcl" }
            ]
        }
        },
        {
        "name": "color",
        "type": "ordinal",
        "domain": ["out", "alert", "in"],
        "range": ["#D55E00", "#E69F00", "#0072B2"]
        }
    ],
    "axes": [
        { "orient": "bottom", "scale": "x", "title": "Observation", "labelAngle": 0, "labelAlign": "center", "labelBaseline": "middle", "labelPadding": 9, "labelFont": "Segoe UI", "labelFontStyle": "normal", "labelOverlap": "greedy", "titleFont": "Bahnschrift SemiBold", "titleFontSize": 12, "titleColor": "#6f6f6f", "tickCount": { "signal": "ceil(width / 28)" } },
        { "orient": "left", "scale": "y", "title": "Measurement", "labelFont": "Bahnschrift", "labelFontStyle": "normal", "titleFont": "Bahnschrift SemiBold", "titleFontSize": 12, "titleColor": "#6f6f6f" }
    ],
    "legends": [],
    "marks": [
        {
        "type": "rect",
        "description": "Background: out of control above UCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "value": 0 },
            "y2": { "scale": "y", "signal": "uclSig" },
            "fill": { "value": "#f8d4cf" },
            "opacity": { "value": 0.45 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Background: alert between UCL and +1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "uclSig" },
            "y2": { "scale": "y", "signal": "upper1" },
            "fill": { "value": "#fde6bc" },
            "opacity": { "value": 0.42 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Background: in-control within ±1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper1" },
            "y2": { "scale": "y", "signal": "lower1" },
            "fill": { "value": "#dceaf7" },
            "opacity": { "value": 0.5 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Background: alert between -1σ and LCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower1" },
            "y2": { "scale": "y", "signal": "lclSig" },
            "fill": { "value": "#fde6bc" },
            "opacity": { "value": 0.42 }
            }
        }
        },
        {
        "type": "rect",
        "description": "Background: out of control below LCL",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lclSig" },
            "y2": { "signal": "height" },
            "fill": { "value": "#f8d4cf" },
            "opacity": { "value": 0.45 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Reference vertical guide (crosshair X)",
        "encode": {
            "update": {
            "x": { "signal": "crossX" },
            "x2": { "signal": "crossX" },
            "y": { "value": 0 },
            "y2": { "signal": "height" },
            "stroke": { "value": "#555" },
            "strokeWidth": { "value": 1 },
            "opacity": { "value": 0.25 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Reference horizontal guide (crosshair Y)",
        "encode": {
            "update": {
            "y": { "signal": "crossY" },
            "y2": { "signal": "crossY" },
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "stroke": { "value": "#555" },
            "strokeWidth": { "value": 1 },
            "opacity": { "value": 0.25 }
            }
        }
        },
        {
        "type": "line",
        "description": "Moving average (window 7)",
        "from": { "data": "dataset" },
        "encode": {
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "run_mean" },
            "stroke": { "value": "#9c9c9c" },
            "strokeWidth": { "value": 1.2 },
            "strokeDash": { "value": [6, 4] },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "line",
        "description": "Main measurements series",
        "from": { "data": "dataset" },
        "encode": {
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "stroke": { "value": "#4e79a7" },
            "strokeWidth": { "value": 1.8 }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Points with state (in/alert/out) and detailed tooltip",
        "from": { "data": "dataset" },
        "encode": {
            "enter": { "size": { "value": 60 }, "strokeWidth": { "value": 1 }, "shape": { "value": "circle" } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "shape": { "signal": "datum.state === 'alert' || datum.state === 'out' ? 'diamond' : 'circle'" },
            "fill": { "signal": "datum.state === 'alert' ? '#E69F00' : datum.state === 'out' ? '#D55E00' : '#0072B2'" },
            "stroke": { "signal": "datum.state === 'alert' ? '#8c5a00' : '#ffffff'" },
            "strokeWidth": { "signal": "datum.state === 'alert' ? 2.4 : 1" },
            "opacity": { "value": 0.92 },
            "tooltip": {
                "signal": "{Observation: datum.obs_num, Measurement: format(datum.med_val, ',.2f'), CL: format(datum.cl, ',.2f'), UCL: format(datum.ucl, ',.2f'), LCL: format(datum.lcl, ',.2f'), State: datum.state, Run7: datum.runFlag ? 'yes' : 'no', MovingAvg: format(datum.run_mean, ',.2f')}"
            }
            },
            "hover": {
            "size": { "value": 110 },
            "stroke": { "value": "#000" }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Outliers (out of control) with halo",
        "from": { "data": "dataset_out" },
        "encode": {
            "enter": { "shape": { "value": "diamond" } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "size": { "value": 260 },
            "fill": { "value": "#ffffff" },
            "fillOpacity": { "value": 0.65 },
            "stroke": { "value": "#D55E00" },
            "strokeWidth": { "value": 1.7 },
            "opacity": { "value": 1 },
            "tooltip": {
                "signal": "{Observation: datum.obs_num, Measurement: format(datum.med_val, ',.2f'), CL: format(datum.cl, ',.2f'), UCL: format(datum.ucl, ',.2f'), LCL: format(datum.lcl, ',.2f'), State: datum.state}"
            }
            }
        }
        },
        {
        "type": "symbol",
        "description": "Halo/emphasis on runFlag or hover",
        "from": { "data": "dataset" },
        "encode": {
            "enter": { "size": { "value": 0 } },
            "update": {
            "x": { "scale": "x", "field": "obs_num", "band": 0.5 },
            "y": { "scale": "y", "field": "med_val" },
            "shape": { "signal": "datum.state === 'alert' || datum.state === 'out' ? 'diamond' : 'circle'" },
            "fill": { "signal": "datum.state === 'out' ? '#e63e44' : '#2c7bb6'" },
            "stroke": { "signal": "datum.state === 'alert' ? '#f7b500' : datum.state === 'out' ? '#e63e44' : '#2c7bb6'" },
            "strokeWidth": { "signal": "datum.state === 'alert' || datum.state === 'out' ? 3 : 2" },
            "size": { "signal": "(hover && hover.obs_num === datum.obs_num) || datum.runFlag ? 200 : 0" },
            "opacity": { "signal": "datum.runFlag ? 1 : 0.9" }
            }
        }
        },
        {
        "type": "rule",
        "description": "CL (center) dashed line",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0" },
            "stroke": { "value": "#f28e2c" },
            "strokeDash": { "value": [6, 3] },
            "strokeWidth": { "value": 2 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Upper control limit (UCL)",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].ucl : 0" },
            "stroke": { "value": "#e15759" },
            "strokeDash": { "value": [3, 3] },
            "strokeWidth": { "value": 1.6 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "+1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper1" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.7 }
            }
        }
        },
        {
        "type": "rule",
        "description": "+2σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "upper2" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.55 }
            }
        }
        },
        {
        "type": "rule",
        "description": "Lower control limit (LCL)",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].lcl : 0" },
            "stroke": { "value": "#e15759" },
            "strokeDash": { "value": [3, 3] },
            "strokeWidth": { "value": 1.6 },
            "opacity": { "value": 0.9 }
            }
        }
        },
        {
        "type": "rule",
        "description": "-1σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower1" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.7 }
            }
        }
        },
        {
        "type": "rule",
        "description": "-2σ",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "scale": "y", "signal": "lower2" },
            "stroke": { "value": "#7f8c8d" },
            "strokeDash": { "value": [4, 4] },
            "opacity": { "value": 0.55 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].ucl : 0", "offset": -6 },
            "text": { "value": "UCL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "upper1" },
            "text": { "value": "+1σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "upper2" },
            "text": { "value": "+2σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0", "offset": -6 },
            "text": { "value": "CL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].cl : 0", "offset": 10 },
            "text": { "value": "median" },
            "align": { "value": "left" },
            "baseline": { "value": "top" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "fontStyle": { "value": "italic" },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "data('dataset')[0] ? data('dataset')[0].lcl : 0", "offset": -6 },
            "text": { "value": "LCL" },
            "align": { "value": "left" },
            "baseline": { "value": "bottom" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "lower1" },
            "text": { "value": "-1σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "signal": "width + 2" },
            "y": { "scale": "y", "signal": "lower2" },
            "text": { "value": "-2σ" },
            "align": { "value": "left" },
            "baseline": { "value": "middle" },
            "fill": { "value": "#2d3436" },
            "fontSize": { "value": 11 },
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 3 },
            "strokeOpacity": { "value": 0.6 }
            }
        }
        },
        {
        "type": "rule",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "value": 0 },
            "stroke": { "value": "#7e3f98" },
            "strokeDash": { "value": [4, 3] },
            "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "rule",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "x2": { "signal": "width" },
            "y": { "value": 0 },
            "stroke": { "value": "#7e3f98" },
            "strokeDash": { "value": [4, 3] },
            "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "y": { "value": 0 },
            "text": { "value": "" },
            "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "text",
        "encode": {
            "update": {
            "x": { "value": 0 },
            "y": { "value": 0 },
            "text": { "value": "" },
            "opacity": { "value": 0 }
            }
        }
        },
        {
        "type": "rect",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx) ) * cardW + 6" },
            "y": { "signal": "cardY" },
            "width": { "signal": "cardW - 8" },
            "height": { "signal": "cardH" },
            "fill": { "field": "bg" },
            "stroke": { "value": "#d7d7d7" },
            "cornerRadius": { "value": 4 },
            "opacity": { "signal": "data('kpi').length ? 0.92 : 0" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx)) * cardW + 12" },
            "y": { "signal": "cardY + 12" },
            "text": { "field": "label" },
            "fontWeight": { "value": "bold" },
            "fontSize": { "value": 11 },
            "fill": { "value": "#2d3436" },
            "opacity": { "signal": "data('kpi').length ? 1 : 0" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "cards" },
        "encode": {
            "update": {
            "x": { "signal": "((isValid(datum.idxDyn) ? datum.idxDyn - 1 : datum.idx)) * cardW + 12" },
            "y": { "signal": "cardY + 26" },
            "text": { "signal": "data('kpi').length ? format(data('kpi')[0][datum.field], datum.fmt) : ''" },
            "fontSize": { "value": 11 },
            "fill": { "value": "#37474f" }
            }
        }
        },
        {
        "type": "rect",
        "from": { "data": "rules_grid" },
        "encode": {
            "update": {
            "x": { "signal": "gridX + (datum.idx % gridCols) * gridCell" },
            "y": { "signal": "gridY + floor(datum.idx / gridCols) * gridCell" },
            "width": { "signal": "gridCell - 2" },
            "height": { "signal": "gridCell - 2" },
            "fill": { "signal": "datum.count > 0 ? '#e57373' : '#e0e6f5'" },
            "stroke": { "value": "#aeb7d3" },
            "cornerRadius": { "value": 2 },
            "tooltip": { "signal": "{rule: datum.rule, detail: datum.desc, violations: datum.count}" }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "rules_grid" },
        "encode": {
            "update": {
            "x": { "signal": "gridX + (datum.idx % gridCols) * gridCell + (gridCell - 2) / 2" },
            "y": { "signal": "gridY + floor(datum.idx / gridCols) * gridCell + (gridCell - 2) / 2 + 4" },
            "text": { "signal": "datum.count > 0 ? datum.count : ''" },
            "fontSize": { "value": 9 },
            "fontWeight": { "value": "bold" },
            "align": { "value": "center" },
            "fill": { "value": "#2f2f2f" }
            }
        }
        }
    ],
    "config": {
        "axis": { "grid": true, "labelFontSize": 11, "titleFontSize": 12 },
        "legend": { "labelFontSize": 11, "titleFontSize": 12 }
    }
}
